## Uninstall Anypoint Monitoring

Follow the steps below to completely and permanently uninstall Anypoint Monitoring Visualizer Addon.

WARNING: All related data and metrics related to Anypoint Monitoring Visualizer Addon will be lost

1. Create a file named `amv-uninstall.sh` inside gravity with the following contents:
```bash
kubectl patch configmap anypoint-addons -p '{"data": {"AMV_ADDON_ENABLED": "false"}}'
# Delete Everything for ${COMPONENT}
COMPONENTS=( dias monitoring-center visualizer ) # Add more components to this list, separated by space
for COMPONENT in ${${COMPONENT}[@]}; do
  # Delete HELM Charts
  helm ls --all | grep ${COMPONENT}
  helm delete --purge $(helm ls --all | grep ${COMPONENT} | awk -F' ' '{print $1}')
  sleep 10
  # Delete JOBS
  kubectl get jobs -n ${COMPONENT}
  kubectl delete jobs -n ${COMPONENT} $(kubectl get jobs -n ${COMPONENT} | awk -F' ' '{print $1}')
  kubectl get jobs -n ${COMPONENT}
  sleep 10
  # Delete PVCs
  kubectl get pvc -n ${COMPONENT}
  kubectl delete pvc -n ${COMPONENT} $(kubectl get pvc -n ${COMPONENT} | awk -F' ' '{print $1}') --force --grace-period 0
  kubectl get pvc -n ${COMPONENT}
  sleep 10
  # Delete all DIAS pods
  kubectl delete ${COMPONENT} -n dias $(kubectl get pods -n ${COMPONENT} | awk -F" " '{print $1}') --force --grace-period 0
  kubectl get all -n ${COMPONENT}
  sleep 10
  # Delete all DIAS secrets
  # DONOT delete cluster-ca, cluster-default-ssl!!!!
  kubectl get secrets -n ${COMPONENT}
  kubectl delete secrets -n ${COMPONENT} $(kubectl get secrets -n ${COMPONENT} | grep ${COMPONENT} | awk -F' ' '{print $1}')
  if [[ ${COMPONENT} == 'dias' ]]; then
    kubectl delete secret -n dias influxdb-shared-secret insight-ca insight-cassandra-certs
  fi
  kubectl get secrets -n ${COMPONENT}
  sleep 10
done

# Delete stolon-amv
gravity app uninstall stolon-amv

# Delete Infludb License
kubectl delete secret influxdb-license --ignore-not-found
```

1. Run `chmod +x uninstall-amv.sh`

1. Run `./uninstall-amv.sh`

1. Once run, validate that the pods in all related namespaces are gone by running the following commands:

`kubectl get pods -n dias`
`kubectl get pods -n monitoring-center`
`kubectl get pods -n visualizer`

1. There might still be dangling Persistent Volumes and Persistent Volume Claims. Check by running the following commands
```
kubectl get pvc -n dias
kubectl get pv | grep dias
```
1. If after 10 mins after deleting the helm charts the volumes still exist then they need to be deleted manually:

To delete Persistent Volumes:
```
kubectl delete pv $(kubectl get pv | grep "dias" | awk -F" " '{print $1}')
```
To delete Persistent Volume Claims:
```
kubectl delete pvc $(kubectl get pvc -n dias | awk -F" " '{print $1}') -n dias
```
